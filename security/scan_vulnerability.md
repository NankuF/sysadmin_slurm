## Сканирование сервера на уязвимости

Trivy — это мощный и универсальный сканер безопасности, который позволяет выявлять уязвимости, ошибки конфигурации и другие проблемы в различных артефактах, включая контейнерные образы, файловые системы, репозитории и Kubernetes-кластеры. Он широко используется DevOps и командами безопасности благодаря своей простоте и эффективности.​

Основные возможности Trivy:

Сканирование контейнерных образов: анализирует образы на наличие известных уязвимостей в ОС и зависимостях приложений.​

Проверка файловых систем: сканирует локальные файловые системы на предмет уязвимостей и ошибок конфигурации.​

Анализ репозиториев: исследует удалённые Git-репозитории на наличие уязвимостей в коде и зависимостях.​

Интеграция с Kubernetes: проверяет конфигурации Kubernetes на наличие ошибок и потенциальных рисков.​

Сканирование облачных сред: анализирует инфраструктуру как код (IaC) и конфигурации облачных сервисов на предмет ошибок и уязвимостей.​

Trivy можно установить различными способами, включая использование контейнерных образов, пакетных менеджеров и загрузку бинарных файлов. Подробные инструкции по установке доступны в официальной документации. ​

Trivy поддерживает интеграцию с различными CI/CD системами, что позволяет автоматизировать процессы сканирования и обеспечения безопасности на всех этапах разработки и деплоя приложений.​


## Алгоритм
0) Переходим под рута
1) обновить ядро и установить trivy
2) Использовать скрипт для ежедневной проверки
3) Отправлять сообщение об обнаруженных уязвимостях (опционально, но желательно)

## Подготовка
- обновим ядро и установим необходимые утилиты
```bash
sudo -s
```
```bash
apt update && apt upgrade -y
```
Соглашаемся со всеми всплывающими окнами и выполняем
```bash
reboot
```
- Опционально - могло обновиться ядро (держим в уме)
```bash
uname -r
ls -la /boot/
```

##  Установка trivy и его настройка
При выполнении trivy она сканирует файлы, и в старом ядре покажет уязвимости, его требуется исключить из поиска либо удалить.<br>
- Скачиваем репозиторий и trivy
```bash
apt install wget gnupg
wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb generic main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
apt update
apt install trivy jq
```
- Создать скрипт для запуска
```bash
cat > /usr/local/bin/daily-vuln-scan.sh << 'EOF'
#!/bin/bash
set -o errexit   # abort on nonzero exit status
set -o nounset   # abort on unbound variable
set -o pipefail  # don't hide errors within pipes

# Параметры (можно изменить при необходимости)
LOG_DIR="/var/log/trivy"
SCAN_CMD="trivy fs --quiet --scanners vuln --severity  HIGH,CRITICAL --format json /"
DATE=$(date '+%Y-%m-%d')
TODAY_LOG="$LOG_DIR/trivy_scan_$DATE.log"
YESTERDAY_LOG="$LOG_DIR/trivy_scan_$(date -d 'yesterday' '+%Y-%m-%d').log"

# Проверка наличия директории логов
function check_log_directory() {
	if [ ! -d "$LOG_DIR" ]; then
    	echo "Log directory does not exist. Creating: $LOG_DIR"
    	mkdir -p "$LOG_DIR" || { echo "Failed to create log directory"; exit 1; }
	fi
}

# Выполнение сканирования
function run_scan() {
	echo "Running vulnerability scan..."
	SCAN_RESULT=$($SCAN_CMD)
	if [ $? -ne 0 ]; then
    	echo "Error: Vulnerability scan failed. Exiting."
    	exit 1
	fi
	echo "$SCAN_RESULT" | jq -r '.Results[].Vulnerabilities[] | "\(.PkgName) : \(.VulnerabilityID)"' | sort > "$TODAY_LOG"
}

# Подсчёт числа уязвимостей
function count_vulnerabilities() {
	TOTAL_VULNS=$(wc -l < "$TODAY_LOG")
	echo "Total vulnerabilities found: $TOTAL_VULNS"
	if [ "$TOTAL_VULNS" -ne 0 ]; then
    	echo "Warning: There are vulnerabilities on the system."
	else
    	echo "No vulnerabilities found on the system."
	fi
}

# Проверка на разницу с предыдущим днём
function diff_with_previous_scan() {
	if [ -f "$YESTERDAY_LOG" ]; then
    	NEW_VULNS=$(diff "$YESTERDAY_LOG" "$TODAY_LOG" | grep '^>' | sed 's/^> //')
    	if [ -n "$NEW_VULNS" ]; then
        	echo "New vulnerabilities found since the last scan:"
        	echo "$NEW_VULNS"
    	else
        	echo "No new vulnerabilities found since the last scan."
    	fi
	else
    	echo "Previous day's log file not found ($YESTERDAY_LOG). Treating as first run."
	fi
}

# Основной процесс
function main() {
	check_log_directory
	run_scan
	count_vulnerabilities
	diff_with_previous_scan
}

# Запуск основного процесса
main
EOF

chmod +x /usr/local/bin/daily-vuln-scan.sh
/usr/local/bin/daily-vuln-scan.sh
```
- Добавить в crontab (мы под рутом, поэтому без sudo)
```bash
crontab -e
```
### Тестовый вариант каждую минуту
Вставляем в конец строку (после проверки поставим нормальное время)
```bash
*/1 * * * * /usr/local/bin/daily-vuln-scan.sh
```
### Рабочий вариант в час ночи
```bash
0 1 * * * /usr/local/bin/daily-vuln-scan.sh
```
- Проверяем что скрипт запускается
```bash
journalctl |grep trivy
```
- Проверяем логи
```bash
cat /var/log/trivy/trivy_scan_2025-10-01.log
```
- Если старое (неиспользуемое) ядро показывает ошибки - удаляем его<br>
- неиспользуемое ядро это<br>
`lrwxrwxrwx  1 root root       25 May 10  2023 vmlinuz.old -> vmlinuz-5.15.0-71-generic`
- используемое ядро<br>
`lrwxrwxrwx  1 root root       29 Oct  1 08:05 initrd.img -> initrd.img-5.15.0-157-generic`
- ВАЖНО если они одинаковые - нельзя удалять старое ядро!
```bash
root@security-ubnt:/home/vagrant# ls -la /boot
total 98800
drwxr-xr-x  3 root root     4096 Oct  1 08:06 .
drwxr-xr-x 19 root root     4096 Oct  1 08:06 ..
-rw-------  1 root root  6299045 Sep 17 19:47 System.map-5.15.0-157-generic
-rw-------  1 root root  6261152 Apr 18  2023 System.map-5.15.0-71-generic
-rw-r--r--  1 root root   262121 Sep 17 19:47 config-5.15.0-157-generic
-rw-r--r--  1 root root   261914 Apr 18  2023 config-5.15.0-71-generic
drwxr-xr-x  5 root root     4096 Oct  1 08:06 grub
lrwxrwxrwx  1 root root       29 Oct  1 08:05 initrd.img -> initrd.img-5.15.0-157-generic
-rw-r--r--  1 root root 32106092 Oct  1 08:06 initrd.img-5.15.0-157-generic
-rw-r--r--  1 root root 32675636 Oct  1 08:05 initrd.img-5.15.0-71-generic
lrwxrwxrwx  1 root root       28 May 10  2023 initrd.img.old -> initrd.img-5.15.0-71-generic
v
-rw-------  1 root root 11713384 Sep 17 20:57 vmlinuz-5.15.0-157-generic
-rw-------  1 root root 11571144 Apr 18  2023 vmlinuz-5.15.0-71-generic
lrwxrwxrwx  1 root root       25 May 10  2023 vmlinuz.old -> vmlinuz-5.15.0-71-generic
```
```bash
apt purge linux-image-5.15.0-71-generic
```
```bash
apt autoremove --purge
```

## Настроить сборщик логов ELK
лог /var/log/trivy/* надо собирать сборщиком логов в центральное хранилище логов и уже там  настраивать фильтры уведомлений по уязвимостям, тк серверов может быть больше 100.
# Расшифровка /etc/passwd и /etc/shadow

## sudo cat /etc/passwd - файл с пользователями
```text
ubuntu:x:1001:1001:Ubuntu:/home/ubuntu:/bin/bash
lxd:x:999:100::/var/snap/lxd/common/lxd:/bin/false
landscape:x:111:116::/var/lib/landscape:/usr/sbin/nologin
```

login:пароль хранится в /etc/shadow:uid:gid:GOSEC:homedir:shell

## sudo cat /etc/shadow - хранит хэши паролей пользователей и информацию о сроках действия паролей.

```text
vagrant:$y$j9T$CrC/yoZl4byeA4EtU74k91$g2NmyYhOLv1ZU1LpmAwvIYG/LwFqCTJppTmzSw4dcM2:19487:0:99999:7:::
ubuntu:!:20335:0:99999:7:::
lxd:!:20335::::::
```
```text
$y$j9T$CrC/yoZl4byeA4EtU74k91$g2NmyYhOLv1ZU1LpmAwvIYG/LwFqCTJppTmzSw4dcM2  $хэш-функция$случайная_соль$параметры_соли$хэшированный_пароль_с_солью
```

```text
Пользователь: ubuntu
Пароль: заблокирован (!)
Дата последней смены пароля: 20335 дней с 01.01.1970 (примерно 07.12.2024)
Минимальный срок действия пароля: 0 дней (можно менять сразу)
Максимальный срок действия пароля: 99999 дней (~273 года, фактически "никогда не истекает")
Период предупреждения перед истечением: 7 дней
Период неактивности после истечения: не задан
Дата окончания срока действия учётной записи: не задана
Резервное поле: не используется
```

# Памятка: `*` и `!` в /etc/shadow

В файле `/etc/shadow` символы `*` и `!` в поле пароля означают, что **вход по паролю запрещён**, но другие способы входа могут работать.

---

## 🔐 Значение символов

### `*` — пароль отсутствует или отключён
- Указывает, что у пользователя **не установлен пароль**.
- Часто встречается при создании пользователя с `--disabled-password`.

### `!` — пароль заблокирован
- Пароль был, но заблокирован командой `sudo passwd -l username`.
- Чтобы разблокировать: `sudo passwd -u username`.

> ⚠️ Оба символа **запрещают аутентификацию по паролю**, но **не блокируют полностью учётную запись**.

---

## 🚪 Можно ли войти под таким пользователем?

| Способ входа                  | Работает? | Условие |
|-------------------------------|----------|--------|
| `ssh user@host` (по ключу)     | ✅ Да     | Если в `~/.ssh/authorized_keys` есть ключ |
| `sudo su - user`               | ✅ Да     | Если у вас есть права sudo |
| `su - user`                    | ❌ Нет    | Требует пароль пользователя |
| SSH с вводом пароля           | ❌ Нет    | Вход по паролю отключён |

---

## ⚙️ Важно
- Символы `*` и `!` **не мешают работе SSH-ключей**.
- Учётная запись остаётся активной — только **парольная аутентификация отключена**.
- Используется в облачных образах (AWS, Vagrant и др.) для безопасности.

---

## 🔧 Полезные команды
```bash
# Заблокировать пароль
sudo passwd -l username

# Разблокировать пароль
sudo passwd -u username

# Установить пароль
sudo passwd username

# Проверить статус
sudo passwd -S username
# Вывод: username L 20335 0 99999 7 (- — заблокирован, P — пароль установлен)
```
# 🔒 Памятка: Как заблокировать пользователя в Linux

## 🧩 Основные способы блокировки

| Способ | Команда | Что блокирует |
|-------|--------|----------------|
| Заблокировать пароль | `sudo passwd -l username` | Только вход по паролю |
| Запретить оболочку | `sudo usermod -s /bin/false` или `sudo usermod -s /usr/sbin/nologin` | Интерактивный вход |
| Удалить SSH-ключи | `sudo mv /home/username/.ssh /home/username/.ssh.bak` | Вход по SSH |
| Полная блокировка | Комбинация выше | Все способы входа |

---

## 🔄 Разница между `/bin/false` и `/usr/sbin/nologin`

Оба используются как **"недопустимая оболочка"**, чтобы запретить вход, но работают по-разному.

### `/bin/false`
- Это **обычный бинарный файл**, который ничего не делает и возвращает код выхода `1` (ошибка).
- При попытке входа:
  - Сессия **мгновенно завершается**
  - **Нет сообщения** пользователю
- Подходит для служебных учётных записей (демоны, системы)

> ❌ Минус: пользователь не понимает, что произошло.

### `/usr/sbin/nologin`
- Специально создан для этой цели.
- При попытке входа:
  - Выводит **дружелюбное сообщение**, например:
    `This account is currently not available.`
  - Затем завершает сессию
- Сообщение можно **настроить** (в некоторых системах — через файл `/etc/nologin.txt`)

> ✅ Плюс: пользователь видит, что доступ запрещён.

---

## 🛠️ Как установить?

```bash
# Заблокировать пароль
sudo passwd -l username

# Установить оболочку nologin (рекомендуется)
sudo usermod -s /usr/sbin/nologin username

# Или использовать false (для системных учёток)
sudo usermod -s /bin/false username

# Удалить или отключить SSH-доступ
sudo mv /home/username/.ssh /home/username/.ssh.bak 2>/dev/null || true
```
Рекомендуемый способ блокировки
```bash
sudo usermod -L -s /usr/sbin/nologin username
sudo mv /home/username/.ssh /home/username/.ssh.bak 2>/dev/null || true
sudo pkill -u username 2>/dev/null || true
```